3ë‹¨ê³„: Docker Registry ì„¤ì¹˜ (ë¡œì»¬) ë‹¨ì¼ ì„œë²„ í™˜ê²½ì—ì„œ Private Docker Registryë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤.

3-1. Registry ë””ë ‰í† ë¦¬ ìƒì„±

```bash
# 1. Registry ë°ì´í„° ì €ì¥ ë””ë ‰í† ë¦¬ ìƒì„±
sudo mkdir -p /data/docker-registry/{data,auth,certs}
sudo chown -R $USER:$USER /data/docker-registry
cd /data/docker-registry
# 2. ë””ë ‰í† ë¦¬ í™•ì¸
ls -la
```

**ì˜ˆìƒ ì¶œë ¥:**

```
drwxr-xr-x. auth
drwxr-xr-x. certs
drwxr-xr-x. data
```

3-2. Registry ì¸ì¦ ì„¤ì •

```bash
# 1. htpasswd ì„¤ì¹˜
sudo dnf install -y httpd-tools
# 2. Registry ì‚¬ìš©ì ìƒì„± (username: admin, password: admin123)
htpasswd -Bc auth/htpasswd admin
# ë¹„ë°€ë²ˆí˜¸ ì…ë ¥: admin123
# ë¹„ë°€ë²ˆí˜¸ í™•ì¸: admin123
# 3. ìƒì„± í™•ì¸
cat auth/htpasswd
```

**ì˜ˆìƒ ì¶œë ¥:**

```
New password:
Re-type new password:
Adding password for user admin
admin:$2y$05$xxxxxxxxxxxxxxxxxxxx
```

3-3. ìì²´ ì„œëª… ì¸ì¦ì„œ ìƒì„± (ê°œë°œìš©)

```bash
# 1. ì„œë²„ì˜ IP ì£¼ì†Œ í™•ì¸
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "ì„œë²„ IP: $SERVER_IP"
# 2. ìì²´ ì„œëª… ì¸ì¦ì„œ ìƒì„±
openssl req -newkey rsa:4096 -nodes -sha256 \
  -keyout certs/domain.key -x509 -days 365 \
  -out certs/domain.crt \
  -subj "/C=KR/ST=Seoul/L=Seoul/O=MyCompany/CN=$SERVER_IP"
# 3. ì¸ì¦ì„œ í™•ì¸
ls -lh certs/
```

**ì˜ˆìƒ ì¶œë ¥:**

```
ì„œë²„ IP: 192.168.1.100
Generating a RSA private key
.....++++
writing new private key to 'certs/domain.key'
-rw-r--r--. domain.crt
-rw-------. domain.key
```

3-4. Docker Registry ì»¨í…Œì´ë„ˆ ì‹¤í–‰

```bash
# 1. Registry ì‹¤í–‰
docker run -d \
  --restart=always \
  --name registry \
  -v /data/docker-registry/data:/var/lib/registry \
  -v /data/docker-registry/auth:/auth \
  -v /data/docker-registry/certs:/certs \
  -e REGISTRY_HTTP_ADDR=0.0.0.0:5000 \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
  -e REGISTRY_AUTH=htpasswd \
  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
  -e REGISTRY_AUTH_HTPASSWD_REALM="Registry Realm" \
  -p 5000:5000 \
  registry:2
# 2. ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í™•ì¸
docker ps | grep registry
```

**ì˜ˆìƒ ì¶œë ¥:**

```
CONTAINER ID   IMAGE        COMMAND                  CREATED         STATUS         PORTS                    NAMES
abc123def456   registry:2   "/entrypoint.sh /etcâ€¦"   5 seconds ago   Up 3 seconds   0.0.0.0:5000->5000/tcp   registry
```

3-5. Registry ì¸ì¦ì„œ ì‹œìŠ¤í…œì— ì¶”ê°€

```bash
# 1. ì„œë²„ IP í™•ì¸
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "ì„œë²„ IP: $SERVER_IP"
# 2. Dockerìš© ì¸ì¦ì„œ ë””ë ‰í† ë¦¬ ìƒì„±
sudo mkdir -p /etc/docker/certs.d/$SERVER_IP:5000
# 3. ì¸ì¦ì„œ ë³µì‚¬
sudo cp /data/docker-registry/certs/domain.crt /etc/docker/certs.d/$SERVER_IP:5000/ca.crt
# 4. ì‹œìŠ¤í…œ CA ì €ì¥ì†Œì—ë„ ì¶”ê°€
sudo cp /data/docker-registry/certs/domain.crt /etc/pki/ca-trust/source/anchors/registry-ca.crt
sudo update-ca-trust
# 5. Docker ì¬ì‹œì‘
sudo systemctl restart docker
# 6. Registry ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ (Docker ì¬ì‹œì‘ìœ¼ë¡œ ì¤‘ì§€ë¨)
docker start registry
```

3-6. Registry ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸

```bash
# 1. ì„œë²„ IP í™•ì¸
SERVER_IP=$(hostname -I | awk '{print $1}')
# 2. Registry ë¡œê·¸ì¸
docker login $SERVER_IP:5000
# Username: admin
# Password: admin123
```

**ì˜ˆìƒ ì¶œë ¥:**

```
Username: admin
Password:
WARNING! Your password will be stored unencrypted in /home/user/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store
Login Succeeded
```

3-7. Registry ë™ì‘ í…ŒìŠ¤íŠ¸

```bash
# 1. í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ pull
docker pull hello-world
# 2. ì„œë²„ IP í™•ì¸
SERVER_IP=$(hostname -I | awk '{print $1}')
# 3. ì´ë¯¸ì§€ íƒœê·¸
docker tag hello-world $SERVER_IP:5000/hello-world:test
# 4. Registryì— push
docker push $SERVER_IP:5000/hello-world:test
# 5. Registry ì¹´íƒˆë¡œê·¸ í™•ì¸
curl -u admin:admin123 -k https://$SERVER_IP:5000/v2/_catalog
```

**ì˜ˆìƒ ì¶œë ¥:**

```
The push refers to repository [192.168.1.100:5000/hello-world]
xxx: Pushed
test: digest: sha256:xxx size: xxx
{"repositories":["hello-world"]}
```

3-8. Minikubeì—ì„œ Registry ì ‘ê·¼ ì„¤ì • Minikubeê°€ ë¡œì»¬ Registryë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.

```bash
# 1. ì„œë²„ IP í™•ì¸
SERVER_IP=$(hostname -I | awk '{print $1}')
# 2. Minikubeì— insecure registry ì¶”ê°€
minikube stop
minikube start --insecure-registry="$SERVER_IP:5000"
# 3. Minikube ë‚´ë¶€ì— ì¸ì¦ì„œ ë³µì‚¬
minikube ssh "sudo mkdir -p /etc/docker/certs.d/$SERVER_IP:5000"
cat /data/docker-registry/certs/domain.crt | minikube ssh "sudo tee /etc/docker/certs.d/$SERVER_IP:5000/ca.crt"
# 4. Minikube ì¬ì‹œì‘
minikube stop
minikube start --insecure-registry="$SERVER_IP:5000"
```

**ì˜ˆìƒ ì¶œë ¥:**

```
âœ‹  Stopping node "minikube"  ...
ğŸ›‘  Powering off "minikube" via SSH ...
ğŸ›‘  1 node stopped.
ğŸ˜„  AlmaLinux 9 ìœ„ì˜ minikube v1.32.x
âœ¨  ê¸°ì¡´ í”„ë¡œí•„ì— ê¸°ë°˜í•˜ì—¬ docker ë“œë¼ì´ë²„ë¥¼ ì‚¬ìš©í•˜ëŠ” ì¤‘
ğŸ‘  minikube í´ëŸ¬ìŠ¤í„°ì˜ minikube ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë…¸ë“œë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘
...
ğŸ„  ëë‚¬ìŠµë‹ˆë‹¤!
```

3-9. Minikubeì—ì„œ Registry ì ‘ê·¼ í…ŒìŠ¤íŠ¸

```bash
# 1. Minikube ë‚´ë¶€ Docker í™˜ê²½ ì‚¬ìš©
eval $(minikube docker-env)
# 2. ì„œë²„ IP í™•ì¸
SERVER_IP=$(hostname -I | awk '{print $1}')
# 3. Minikube ë‚´ì—ì„œ Registry ì ‘ê·¼ í…ŒìŠ¤íŠ¸
docker pull $SERVER_IP:5000/hello-world:test
# 4. ì›ë˜ Docker í™˜ê²½ìœ¼ë¡œ ë³µê·€
eval $(minikube docker-env -u)
```

**ì˜ˆìƒ ì¶œë ¥:**

```
test: Pulling from hello-world
Digest: sha256:xxx
Status: Downloaded newer image for 192.168.1.100:5000/hello-world:test
192.168.1.100:5000/hello-world:test
```

âœ… 3ë‹¨ê³„ í™•ì¸ì‚¬í•­í™•ì¸ ëª…ë ¹ì–´:

```bash
# ì„œë²„ IP ì €ì¥
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "=== Registry ì»¨í…Œì´ë„ˆ ìƒíƒœ ==="
docker ps | grep registry
echo -e "\n=== Registry ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ==="
echo "admin / admin123" | docker login $SERVER_IP:5000 2>&1 | grep -i "login\|error"
echo -e "\n=== Registry ì¹´íƒˆë¡œê·¸ ==="
curl -u admin:admin123 -k https://$SERVER_IP:5000/v2/_catalog
echo -e "\n=== ì„œë²„ IP ==="
echo "Registry URL: $SERVER_IP:5000"
echo -e "\n=== Minikube ìƒíƒœ ==="
minikube status
```
