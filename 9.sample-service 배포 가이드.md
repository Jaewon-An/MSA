9단계: sample-service 배포 가이드

개요이 문서는 sample-service의 Jenkins 파이프라인 구성 및 Kubernetes 배포 과정을 안내합니다.

사전 요구사항

-   Jenkins 설치 및 설정 완료
-   SVN 연동 설정 완료 (svn-credentials)
-   Docker Registry 설정 완료 (docker-registry-credentials)
-   Kubernetes 클러스터 설정 완료 (kubeconfig)
-   config, discovery, apigateway 서비스 배포 완료

배포 구성

1. 서비스 정보

-   서비스명: sample-service
-   SVN 경로: http://10.10.1.3/svn/lib.seoul.go.kr/trunk/sample-service
-   작업 디렉토리: /data/svn-workspace/lib-seoul-trunk/sample-service
-   Docker 이미지: 10.10.1.10:5000/sample-service
-   포트: 8080

2. 배포 환경 Dev 환경

-   Namespace: dev
-   Replicas: 2
-   리소스:
    -   Requests: 256Mi memory, 250m CPU
    -   Limits: 512Mi memory, 500m CPU
-   Java Opts: -Xms256m -Xmx512m Prod 환경
-   Namespace: prod
-   Replicas: 3
-   리소스:
    -   Requests: 512Mi memory, 500m CPU
    -   Limits: 1Gi memory, 1000m CPU
-   Java Opts: -Xms512m -Xmx1024m

3. 의존 서비스

-   Config Server: http://config.{env}.svc.cluster.local:8888
-   Eureka Server: http://discovery.{env}.svc.cluster.local:8761/eureka/

배포 절차 Step 1: 배포 스크립트 실행

```bash
# root 권한으로 실행
cd /tmp
chmod +x setup-sample-service.sh
./setup-sample-service.sh
```

실행 후 다음 파일이 생성됩니다:

-   /data/svn-workspace/lib-seoul-trunk/sample-service/Jenkinsfile
-   /data/svn-workspace/lib-seoul-trunk/sample-service/k8s/deployment-dev.yaml
-   /data/svn-workspace/lib-seoul-trunk/sample-service/k8s/deployment-prod.yaml

Step 2: SVN에 파일 커밋

```bash
cd /data/svn-workspace/lib-seoul-trunk/sample-service
# SVN 상태 확인
svn status
# 파일 추가
svn add Jenkinsfile k8s/
# 커밋
svn commit -m "Add sample-service deployment configuration" --username jnet --password 'jnet@#'
```

Step 3: Jenkins 파이프라인 작업 생성

1. Jenkins 웹 UI 접속

```
http://<Jenkins-Server-IP>:8080
```

2. 새 작업 생성
    - "New Item" 클릭
    - 작업명: sample-service-deploy
    - 유형: "Pipeline" 선택
    - "OK" 클릭
3. 작업 설정 General 탭:
    - Description: "sample-service 자동 배포 파이프라인"
4. Pipeline 탭:
    - Definition: "Pipeline script from SCM" 선택
    - SCM: "Subversion" 선택
    - Repository URL: http://10.10.1.3/svn/lib.seoul.go.kr/trunk/sample-service
    - Credentials: "svn-credentials" 선택
    - Script Path: Jenkinsfile
5. 저장 클릭

Step 4: 배포 실행

1. 첫 번째 빌드 실행
    - Jenkins에서 sample-service-deploy 작업 선택
    - "Build with Parameters" 클릭
    - DEPLOY_ENV: dev 선택
    - "Build" 클릭
2. 빌드 과정 모니터링
    - 빌드 번호 클릭
    - "Console Output" 확인
    - 각 스테이지 진행 상황 확인
3. 배포 확인

```bash
# Pod 상태 확인
kubectl get pods -n dev -l app=sample-service

# 서비스 상태 확인
kubectl get svc -n dev sample-service

# 로그 확인
kubectl logs -n dev -l app=sample-service --tail=100

# Eureka 등록 확인
kubectl port-forward -n dev svc/discovery 8761:8761
# 브라우저에서 http://localhost:8761 접속하여 확인
```

Step 5: Prod 환경 배포 Dev 환경에서 정상 동작 확인 후:

1. Prod 배포 실행
    - "Build with Parameters" 클릭
    - DEPLOY_ENV: prod 선택
    - "Build" 클릭
2. Prod 배포 확인

```bash
kubectl get pods -n prod -l app=sample-service
kubectl get svc -n prod sample-service
```

파이프라인 스테이지

1. Clean Workspace: 작업 공간 정리
2. SVN Checkout: 소스 코드 체크아웃
3. Build Application: Gradle 빌드
4. Run Tests: 단위 테스트 실행
5. Build Docker Image: Docker 이미지 빌드 및 태깅
6. Push to Registry: Docker Registry에 푸시
7. Deploy to Kubernetes: Kubernetes 클러스터에 배포

이미지 태깅 규칙 10.10.1.10:5000/sample-service:r<SVN_REVISION>-b<BUILD_NUMBER> 10.10.1.10:5000/sample-service:latest 예시:

-   10.10.1.10:5000/sample-service:r1234-b56
-   10.10.1.10:5000/sample-service:latest

Health Check Liveness Probe

-   Path: /actuator/health
-   Port: 8080
-   Initial Delay: 60초
-   Period: 10초
-   Timeout: 5초
-   Failure Threshold: 3 Readiness Probe
-   Path: /actuator/health
-   Port: 8080
-   Initial Delay: 30초
-   Period: 10초
-   Timeout: 5초
-   Failure Threshold: 3

롤백 절차자동 롤백파이프라인 실패 시 자동으로 이전 버전으로 롤백됩니다. 수동 롤백

```bash
# 롤백 히스토리 확인
kubectl rollout history deployment/sample-service -n dev
# 이전 버전으로 롤백
kubectl rollout undo deployment/sample-service -n dev
# 특정 revision으로 롤백
kubectl rollout undo deployment/sample-service -n dev --to-revision=2
```

트러블슈팅

1. SVN Checkout 실패

```bash
# SVN 연결 확인
svn info http://10.10.1.3/svn/lib.seoul.go.kr/trunk/sample-service --username jnet --password 'jnet@#'
# Jenkins credentials 재설정
# Jenkins > Manage Jenkins > Credentials
```

2. Docker Build 실패

```bash
# Dockerfile 확인
cd /data/svn-workspace/lib-seoul-trunk/sample-service
cat Dockerfile
# Gradle 빌드 수동 테스트
./gradlew clean build
```

3. Docker Push 실패

```bash
# Registry 연결 확인
curl http://10.10.1.10:5000/v2/_catalog
# Docker login 테스트
docker login 10.10.1.10:5000
```

4. Kubernetes 배포 실패

```bash
# Namespace 확인
kubectl get namespace dev prod
# 배포 상태 확인
kubectl describe deployment sample-service -n dev
# Pod 로그 확인
kubectl logs -n dev -l app=sample-service --tail=100
# 이벤트 확인
kubectl get events -n dev --sort-by='.lastTimestamp'
```

5. Pod가 Running 상태가 안 됨

```bash
# Pod 상세 정보 확인
kubectl describe pod -n dev -l app=sample-service
# 일반적인 원인:
# - 이미지 pull 실패
# - 리소스 부족
# - Config/Discovery 서비스 미실행
# - Health check 실패
```

6. Service Discovery 실패

```bash
# Eureka 서버 확인
kubectl get pods -n dev -l app=discovery
# sample-service 로그에서 Eureka 등록 확인
kubectl logs -n dev -l app=sample-service | grep -i eureka
# Config Server 확인
kubectl get pods -n dev -l app=config
```

모니터링 Pod 상태 모니터링

```bash
# 실시간 Pod 상태 확인
watch kubectl get pods -n dev -l app=sample-service
# 리소스 사용량 확인
kubectl top pods -n dev -l app=sample-service
```

로그 모니터링

```bash
# 실시간 로그 확인
kubectl logs -n dev -l app=sample-service -f
# 특정 Pod 로그
kubectl logs -n dev <pod-name> -f
# 이전 컨테이너 로그
kubectl logs -n dev <pod-name> --previous
```

Eureka Dashboard 확인

```bash
# Port Forward
kubectl port-forward -n dev svc/discovery 8761:8761
# 브라우저에서 접속
# http://localhost:8761
```

추가 설정 API Gateway 연동 sample-service를 API Gateway를 통해 외부에 노출하려면:

1. API Gateway에 라우팅 설정 추가 (application.yml)

```yaml
spring:
    cloud:
        gateway:
            routes:
                - id: sample-service
                  uri: lb://sample-service
                  predicates:
                      - Path=/api/sample/**
                  filters:
                      - StripPrefix=2
```

2. API Gateway 재배포

```bash
# Jenkins에서 apigateway-deploy 실행
```

ConfigMap 설정 (선택사항)

```bash
# ConfigMap 생성
kubectl create configmap sample-service-config \
  --from-literal=app.name=sample-service \
  --from-literal=app.version=1.0.0 \
  -n dev
# deployment.yaml에 volumeMount 추가 필요
```

Secret 설정 (선택사항)

```bash
# Secret 생성
kubectl create secret generic sample-service-secret \
  --from-literal=db-password=mypassword \
  -n dev
# deployment.yaml에 env 추가 필요
```

참고 자료 Jenkins Pipeline 문법

-   https://www.jenkins.io/doc/book/pipeline/syntax/ Kubernetes Deployment
-   https://kubernetes.io/docs/concepts/workloads/controllers/deployment/ Spring Cloud
-   https://spring.io/projects/spring-cloud
-   https://spring.io/projects/spring-cloud-netflix

변경 이력날짜 버전 변경 내용 작성자 2026-01-23 1.0 초기 작성 Admin

문의배포 관련 문제 발생 시:

1. Jenkins Console Output 로그 확인
2. Kubernetes Pod 로그 확인해당 담당자에게 문의
