8ë‹¨ê³„: apigateway ì„œë¹„ìŠ¤ ë°°í¬ íŒŒì´í”„ë¼ì¸ êµ¬ì„± API GatewayëŠ” MSAì˜ ì§„ì…ì ìœ¼ë¡œ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.

8-1. apigateway ì„œë¹„ìŠ¤ í™•ì¸

```bash
# 1. apigateway ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd /data/svn-workspace/lib-seoul-trunk/apigateway
# 2. íŒŒì¼ êµ¬ì¡° í™•ì¸
ls -la
# 3. ë¹Œë“œ íŒŒì¼ í™•ì¸
ls -lh build.gradle pom.xml 2>/dev/null
# 4. Dockerfile í™•ì¸
ls -lh Dockerfile* 2>/dev/null
# 5. í¬íŠ¸ í™•ì¸ (application.yml)
find . -name "application*.yml" -o -name "application*.properties" | xargs grep -i "port" 2>/dev/null | head -5
# 6. Eureka ì„¤ì • í™•ì¸ (discovery ì—°ë™)
find . -name "application*.yml" -o -name "application*.properties" | xargs grep -i "eureka" 2>/dev/null | head -10
```

8-2. í•„ìš”í•œ íŒŒì¼ ìƒì„± Dockerfile ìƒì„±/í™•ì¸

```bash
cd /data/svn-workspace/lib-seoul-trunk/apigateway
# Dockerfileì´ ì—†ë‹¤ë©´ ìƒì„±
if [ ! -f Dockerfile ]; then
cat > Dockerfile << 'EOF'
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY build/libs/*.jar app.jar
EXPOSE 8000
ENTRYPOINT ["java", "-jar", "app.jar"]
EOF
echo "âœ… Dockerfile ìƒì„±"
else
echo "âœ… Dockerfile ì´ë¯¸ ì¡´ì¬"
cat Dockerfile
fi
```

Kubernetes Deployment íŒŒì¼ ìƒì„±

```bash
cd /data/svn-workspace/lib-seoul-trunk/apigateway
mkdir -p k8s
# dev í™˜ê²½
cat > k8s/deployment-dev.yaml << 'EOF'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apigateway
  namespace: dev
  labels:
    app: apigateway
    env: dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: apigateway
  template:
    metadata:
      labels:
        app: apigateway
        env: dev
    spec:
      imagePullSecrets:
      - name: regcred
      containers:
      - name: apigateway
        image: 10.10.1.10:5000/apigateway:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8000
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "dev"
        - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
          value: "http://discovery:8761/eureka/"
        - name: SPRING_CLOUD_CONFIG_URI
          value: "http://config:8888"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8000
          initialDelaySeconds: 120
          periodSeconds: 10
          failureThreshold: 5
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8000
          initialDelaySeconds: 90
          periodSeconds: 5
          failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: apigateway
  namespace: dev
spec:
  selector:
    app: apigateway
  ports:
  - protocol: TCP
    port: 8000
    targetPort: 8000
  type: ClusterIP
EOF
# prod í™˜ê²½
cat > k8s/deployment-prod.yaml << 'EOF'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apigateway
  namespace: prod
  labels:
    app: apigateway
    env: prod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: apigateway
  template:
    metadata:
      labels:
        app: apigateway
        env: prod
    spec:
      imagePullSecrets:
      - name: regcred
      containers:
      - name: apigateway
        image: 10.10.1.10:5000/apigateway:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8000
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
          value: "http://discovery:8761/eureka/"
        - name: SPRING_CLOUD_CONFIG_URI
          value: "http://config:8888"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8000
          initialDelaySeconds: 120
          periodSeconds: 10
          failureThreshold: 5
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8000
          initialDelaySeconds: 90
          periodSeconds: 5
          failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: apigateway
  namespace: prod
spec:
  selector:
    app: apigateway
  ports:
  - protocol: TCP
    port: 8000
    targetPort: 8000
  type: ClusterIP
EOF
echo "âœ… Kubernetes manifest ìƒì„± ì™„ë£Œ"
```

Jenkinsfile ìƒì„±

```bash
cd /data/svn-workspace/lib-seoul-trunk/apigateway
cat > Jenkinsfile << 'EOFPIPE'
pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = '10.10.1.10:5000'
        SERVICE_NAME = 'apigateway'
        DOCKER_IMAGE = "${DOCKER_REGISTRY}/${SERVICE_NAME}"
        BUILD_TAG = "${env.BUILD_NUMBER}"
    }

    parameters {
        choice(
            name: 'DEPLOY_ENV',
            choices: ['dev', 'prod'],
            description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        )
    }

    stages {
        stage('Clean Workspace') {
            steps {
                deleteDir()
            }
        }

        stage('SVN Checkout') {
            steps {
                script {
                    def svnInfo = checkout([
                        $class: 'SubversionSCM',
                        locations: [[
                            remote: 'http://10.10.1.3/svn/lib.seoul.go.kr/trunk/apigateway',
                            credentialsId: 'svn-credentials',
                            local: '.',
                            depthOption: 'infinity',
                            ignoreExternalsOption: true
                        ]],
                        quietOperation: false,
                        workspaceUpdater: [$class: 'CheckoutUpdater']
                    ])

                    env.SVN_REVISION = svnInfo.SVN_REVISION
                    echo "âœ… SVN Checkout ì™„ë£Œ - Revision: ${env.SVN_REVISION}"
                }
            }
        }

        stage('Build Application') {
            steps {
                script {
                    echo "Gradle ë¹Œë“œ ì‹œì‘..."
                    sh '''
                        chmod +x gradlew
                        ./gradlew clean build -x test
                    '''
                }
            }
        }

        stage('Run Tests') {
            steps {
                sh './gradlew test || true'
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo "Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
                    echo "Revision: ${env.SVN_REVISION}, Build: ${env.BUILD_TAG}"

                    sh """
                        docker build -t ${DOCKER_IMAGE}:r${env.SVN_REVISION}-b${env.BUILD_TAG} .
                        docker tag ${DOCKER_IMAGE}:r${env.SVN_REVISION}-b${env.BUILD_TAG} ${DOCKER_IMAGE}:latest
                    """
                }
            }
        }

        stage('Push to Registry') {
            steps {
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'docker-registry-credentials',
                        usernameVariable: 'REGISTRY_USER',
                        passwordVariable: 'REGISTRY_PASS'
                    )]) {
                        sh """
                            echo \$REGISTRY_PASS | docker login ${DOCKER_REGISTRY} -u \$REGISTRY_USER --password-stdin
                            docker push ${DOCKER_IMAGE}:r${env.SVN_REVISION}-b${env.BUILD_TAG}
                            docker push ${DOCKER_IMAGE}:latest
                            docker logout ${DOCKER_REGISTRY}
                        """
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    withKubeConfig([credentialsId: 'kubeconfig']) {
                        sh """
                            echo "Kubernetesì— ë°°í¬ ì¤‘... (${params.DEPLOY_ENV})"
                            echo "Image: ${DOCKER_IMAGE}:r${env.SVN_REVISION}-b${env.BUILD_TAG}"

                            if kubectl get deployment ${SERVICE_NAME} -n ${params.DEPLOY_ENV} 2>/dev/null; then
                                echo "ê¸°ì¡´ ë°°í¬ ì—…ë°ì´íŠ¸"
                                kubectl set image deployment/${SERVICE_NAME} \
                                    ${SERVICE_NAME}=${DOCKER_IMAGE}:r${env.SVN_REVISION}-b${env.BUILD_TAG} \
                                    -n ${params.DEPLOY_ENV}
                            else
                                echo "ì´ˆê¸° ë°°í¬"
                                kubectl apply -f k8s/deployment-${params.DEPLOY_ENV}.yaml

                                kubectl set image deployment/${SERVICE_NAME} \
                                    ${SERVICE_NAME}=${DOCKER_IMAGE}:r${env.SVN_REVISION}-b${env.BUILD_TAG} \
                                    -n ${params.DEPLOY_ENV}
                            fi

                            kubectl rollout status deployment/${SERVICE_NAME} \
                                -n ${params.DEPLOY_ENV} --timeout=5m

                            kubectl get pods -n ${params.DEPLOY_ENV} -l app=${SERVICE_NAME}
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "========================================="
            echo "âœ… ë°°í¬ ì„±ê³µ"
            echo "ì„œë¹„ìŠ¤: ${SERVICE_NAME}"
            echo "í™˜ê²½: ${params.DEPLOY_ENV}"
            echo "ì´ë¯¸ì§€: ${DOCKER_IMAGE}:r${env.SVN_REVISION}-b${env.BUILD_TAG}"
            echo "========================================="
        }
        failure {
            echo "âŒ ë°°í¬ ì‹¤íŒ¨"
            script {
                withKubeConfig([credentialsId: 'kubeconfig']) {
                    sh """
                        echo "ë¡¤ë°± ì‹¤í–‰ ì¤‘..."
                        kubectl rollout undo deployment/${SERVICE_NAME} \
                            -n ${params.DEPLOY_ENV} || true
                    """
                }
            }
        }
        always {
            sh 'docker logout ${DOCKER_REGISTRY} || true'
        }
    }
}
EOFPIPE
echo "âœ… Jenkinsfile ìƒì„± ì™„ë£Œ"
```

8-3. SVN ì»¤ë°‹

```bash
cd /data/svn-workspace/lib-seoul-trunk/apigateway
# íŒŒì¼ ì¶”ê°€
svn add Dockerfile 2>/dev/null || true
svn add k8s 2>/dev/null || true
svn add Jenkinsfile 2>/dev/null || true
# ìƒíƒœ í™•ì¸
echo "=== SVN ìƒíƒœ ==="
svn status
# ì»¤ë°‹
svn commit -m "Add Dockerfile, Kubernetes manifests, and Jenkinsfile for apigateway service"
echo "âœ… SVN ì»¤ë°‹ ì™„ë£Œ"
```

8-4. Jenkins Pipeline Job ìƒì„± Jenkins ì›¹:

```bash
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "=============================="
echo "Jenkins: http://$SERVER_IP:8080"
echo "=============================="
```

Jenkins ì›¹ì—ì„œ:

1. New Item í´ë¦­
2. Job ì„¤ì •:

```
   Enter an item name: apigateway-pipeline
   Type: Pipeline
```

-   OK í´ë¦­

3. General ì„¹ì…˜:
    - â˜‘ This project is parameterized ì²´í¬
    - Add Parameter â†’ Choice Parameter

```
     Name: DEPLOY_ENV
     Choices: (í•œ ì¤„ì— í•˜ë‚˜ì”©)
       dev
       prod
     Description: ë°°í¬ í™˜ê²½ ì„ íƒ
```

4. Pipeline ì„¹ì…˜:

```
   Definition: Pipeline script from SCM
   SCM: Subversion
   Repository URL: http://10.10.1.3/svn/lib.seoul.go.kr/trunk/apigateway
   Credentials: svn-credentials
   Script Path: Jenkinsfile
```

5. Save í´ë¦­

8-5. ë¹Œë“œ ì‹¤í–‰ Jenkins ì›¹:

1. apigateway-pipeline í´ë¦­
2. Build with Parameters í´ë¦­
3. DEPLOY_ENV: dev ì„ íƒ
4. Build í´ë¦­
5. Console Output í™•ì¸

âœ… 8ë‹¨ê³„ í™•ì¸

```bash
cd /data/svn-workspace/lib-seoul-trunk/apigateway
echo "=== 1. íŒŒì¼ í™•ì¸ ==="
ls -la Dockerfile Jenkinsfile k8s/
echo -e "\n=== 2. SVN ìƒíƒœ ==="
svn info | grep -E "URL|Revision"
echo -e "\n=== 3. Jenkins Jobs ==="
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "http://$SERVER_IP:8080/job/apigateway-pipeline/"
echo -e "\n=== 4. ë°°í¬ í›„ ì „ì²´ ì„œë¹„ìŠ¤ í™•ì¸ ==="
kubectl get all -n dev
echo -e "\n=== 5. Pod ìƒíƒœ ==="
kubectl get pods -n dev
echo -e "\n=== 6. ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ ==="
kubectl get svc -n dev
```

ğŸ“Š ë¹Œë“œ í›„ ì„œë¹„ìŠ¤ ì—°ë™ í™•ì¸ë°°í¬ê°€ ì„±ê³µí•˜ë©´:

```bash
# 1. apigateway Pod ë¡œê·¸ í™•ì¸ (Eureka ë“±ë¡ í™•ì¸)
kubectl logs -f -n dev -l app=apigateway
# 2. discovery(Eureka) ëŒ€ì‹œë³´ë“œ í™•ì¸ì„ ìœ„í•œ í¬íŠ¸ í¬ì›Œë”©
kubectl port-forward -n dev svc/discovery 8761:8761
# ì›¹ ë¸Œë¼ìš°ì €: http://localhost:8761
# Eureka ëŒ€ì‹œë³´ë“œì—ì„œ APIGATEWAYê°€ ë“±ë¡ë˜ì—ˆëŠ”ì§€ í™•ì¸
# 3. apigateway health í™•ì¸
kubectl exec -n dev -it $(kubectl get pod -n dev -l app=apigateway -o jsonpath='{.items[0].metadata.name}') -- curl -s http://localhost:8000/actuator/health
```
