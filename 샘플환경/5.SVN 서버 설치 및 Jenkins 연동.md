5단계: SVN 서버 설치 및 Jenkins 연동

5-1. SVN 서버 설치

```bash
# 1. Subversion 설치
sudo dnf install -y subversion
# 2. SVN 버전 확인
svn --version | head -3
```

**예상 출력:**

```
svn, version 1.14.x (r...)
   compiled xxx
Copyright (C) 2021 The Apache Software Foundation.
```

5-2. SVN 저장소 생성 (/data 기준)

```bash
# 1. SVN 저장소 디렉토리 생성
sudo mkdir -p /data/svn
# 2. 저장소 생성
sudo svnadmin create /data/svn/microservices
# 3. 저장소 구조 확인
sudo ls -la /data/svn/microservices/
```

**예상 출력:**

```
total 8
drwxr-xr-x. 6 root root   86 Jan 21 19:30 .
drwxr-xr-x. 3 root root   28 Jan 21 19:30 ..
drwxr-xr-x. 2 root root   54 Jan 21 19:30 conf
drwxr-sr-x. 6 root root 4096 Jan 21 19:30 db
-r--r--r--. 1 root root    2 Jan 21 19:30 format
drwxr-xr-x. 2 root root 4096 Jan 21 19:30 hooks
drwxr-xr-x. 2 root root   39 Jan 21 19:30 locks
```

5-3. SVN 사용자 인증 설정

```bash
# 1. passwd 파일 수정 (사용자 추가)
sudo tee /data/svn/microservices/conf/passwd > /dev/null <<EOF
[users]
developer = dev123
jenkins = jenkins123
admin = admin123
EOF
# 2. 생성된 사용자 확인
sudo cat /data/svn/microservices/conf/passwd
```

**예상 출력:**

```
[users]
developer = dev123
jenkins = jenkins123
admin = admin123
```

5-4. SVN 접근 권한 설정

```bash
# 1. authz 파일 수정 (권한 설정)
sudo tee /data/svn/microservices/conf/authz > /dev/null <<EOF
[groups]
developers = developer, admin
ci = jenkins
[/]
@developers = rw
@ci = r
[/trunk]
@developers = rw
@ci = r
[/branches]
@developers = rw
@ci = r
[/tags]
@developers = rw
@ci = r
EOF
# 2. 권한 설정 확인
sudo cat /data/svn/microservices/conf/authz
```

**예상 출력:**

```
[groups]
developers = developer, admin
ci = jenkins
[/]
@developers = rw
@ci = r
...
```

5-5. SVN 서버 설정

```bash
# 1. svnserve.conf 파일 수정
sudo tee /data/svn/microservices/conf/svnserve.conf > /dev/null <<EOF
[general]
anon-access = none
auth-access = write
password-db = passwd
authz-db = authz
realm = Microservices Repository
[sasl]
EOF
# 2. 설정 확인
sudo cat /data/svn/microservices/conf/svnserve.conf | grep -v "^#" | grep -v "^$"
```

**예상 출력:**

```
[general]
anon-access = none
auth-access = write
password-db = passwd
authz-db = authz
realm = Microservices Repository
[sasl]
```

5-6. SVN 서버 시작 (systemd 서비스)

```bash
# 1. systemd 서비스 파일 생성
sudo tee /etc/systemd/system/svnserve.service > /dev/null <<EOF
[Unit]
Description=Subversion protocol daemon
After=network.target
[Service]
Type=forking
ExecStart=/usr/bin/svnserve --daemon --pid-file=/run/svnserve.pid --root=/data/svn
PIDFile=/run/svnserve.pid
Restart=on-failure
[Install]
WantedBy=multi-user.target
EOF
# 2. systemd 재로드
sudo systemctl daemon-reload
# 3. SVN 서비스 시작 및 활성화
sudo systemctl start svnserve
sudo systemctl enable svnserve
# 4. 서비스 상태 확인
sudo systemctl status svnserve
```

**예상 출력:**

```
● svnserve.service - Subversion protocol daemon
   Loaded: loaded (/etc/systemd/system/svnserve.service; enabled; vendor preset: disabled)
   Active: active (running) since Tue 2025-01-21 19:35:00 KST; 5s ago
```

5-7. 방화벽 설정

```bash
# 1. SVN 포트 오픈 (3690)
sudo firewall-cmd --permanent --add-port=3690/tcp
sudo firewall-cmd --reload
# 2. 확인
sudo firewall-cmd --list-ports | grep 3690
```

**예상 출력:**

```
8080/tcp 5000/tcp 6443/tcp 3690/tcp ...
```

5-8. SVN 저장소 초기 구조 생성

```bash
# 1. 임시 작업 디렉토리 생성
mkdir -p ~/svn-temp
cd ~/svn-temp
# 2. 표준 SVN 구조 생성
mkdir -p {trunk,branches,tags}
# 3. trunk 하위에 서비스 디렉토리 생성
mkdir -p trunk/{user-service,order-service,payment-service,product-service,inventory-service,notification-service,auth-service,review-service,shipping-service,analytics-service}
# 4. 각 서비스에 기본 디렉토리 생성
for service in trunk/*; do
    mkdir -p $service/{src/main/{java,resources},k8s}
    touch $service/.gitkeep
done
# 5. 구조 확인
tree -L 2 trunk/
```

**예상 출력:**

```
trunk/
├── analytics-service
│   ├── k8s
│   └── src
├── auth-service
│   ├── k8s
│   └── src
├── inventory-service
...
```

5-9. SVN에 초기 구조 import

```bash
# 1. 서버 IP 확인
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "SVN 서버 주소: svn://$SERVER_IP/microservices"
# 2. SVN import
svn import . svn://$SERVER_IP/microservices -m "Initial repository structure" --username admin --password admin123
```

**예상 출력:**

```
Adding         trunk
Adding         trunk/user-service
Adding         trunk/user-service/.gitkeep
...
Adding         branches
Adding         tags
Committed revision 1.
```

5-10. SVN 체크아웃 테스트

```bash
# 1. 작업 디렉토리로 이동
cd /data
sudo mkdir -p /data/svn-workspace
sudo chown $USER:$USER /data/svn-workspace
cd /data/svn-workspace
# 2. SVN 체크아웃
SERVER_IP=$(hostname -I | awk '{print $1}')
svn checkout svn://$SERVER_IP/microservices --username developer --password dev123
# 3. 체크아웃 확인
ls -la microservices/
cd microservices
svn info
```

**예상 출력:**

```
Checked out revision 1.
total xx
drwxr-xr-x. branches
drwxr-xr-x. tags
drwxr-xr-x. trunk
Path: .
Working Copy Root Path: /data/svn-workspace/microservices
URL: svn://10.10.1.10/microservices
Repository Root: svn://10.10.1.10/microservices
Revision: 1
```

5-11. Jenkins Credentials 설정 (웹 인터페이스) 웹 브라우저에서 Jenkins 접속:

```bash
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "Jenkins URL: http://$SERVER_IP:8080"
echo "Username: admin"
echo "Password: admin123"
```

Jenkins 웹에서:

1. Jenkins 대시보드 → Manage Jenkins → Credentials
2. Stores scoped to Jenkins 섹션에서:
    - (global) 클릭
3. Add Credentials 클릭
4. SVN 인증 정보 추가:

```
   Kind: Username with password
   Scope: Global
   Username: jenkins
   Password: jenkins123
   ID: svn-credentials
   Description: SVN Jenkins User
```

-   Create 클릭

5. Docker Registry 인증 정보 추가:
    - Add Credentials 다시 클릭

```
   Kind: Username with password
   Scope: Global
   Username: admin
   Password: admin123
   ID: docker-registry-credentials
   Description: Docker Registry Login
```

-   Create 클릭

6. Kubernetes Config 추가:
    - Add Credentials 다시 클릭

```
   Kind: Secret file
   Scope: Global
   File: (업로드 버튼 클릭)
```

터미널로 돌아가서 config 파일 복사:

```bash
   # Jenkins kubeconfig를 로컬로 복사 (웹 업로드용)
   sudo cp /var/lib/jenkins/.kube/config ~/jenkins-kubeconfig-upload.yaml
   sudo chown $USER:$USER ~/jenkins-kubeconfig-upload.yaml
   chmod 644 ~/jenkins-kubeconfig-upload.yaml
   echo "파일 위치: ~/jenkins-kubeconfig-upload.yaml"
```

웹에서 계속:

```
   ID: kubeconfig
   Description: Kubernetes Config
```

-   Create 클릭

7. 생성된 Credentials 확인:

```
   svn-credentials
   docker-registry-credentials
   kubeconfig
```

✅ 5단계 확인사항

```bash
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "=== 1. SVN 서비스 상태 ==="
sudo systemctl is-active svnserve
echo -e "\n=== 2. SVN 포트 확인 ==="
sudo netstat -tulpn | grep 3690
echo -e "\n=== 3. SVN 저장소 확인 ==="
sudo ls -la /data/svn/microservices/
echo -e "\n=== 4. SVN 사용자 ==="
sudo cat /data/svn/microservices/conf/passwd | grep -v "^#" | grep -v "^$"
echo -e "\n=== 5. SVN 체크아웃 테스트 ==="
cd /tmp
svn list svn://$SERVER_IP/microservices --username jenkins --password jenkins123
echo -e "\n=== 6. SVN workspace 확인 ==="
ls -la /data/svn-workspace/microservices/ 2>/dev/null || echo "체크아웃 필요"
echo -e "\n=== 7. 시스템 요약 ==="
echo "✅ SVN 서버: svn://$SERVER_IP/microservices"
echo "✅ SVN 사용자: developer(dev123), jenkins(jenkins123), admin(admin123)"
echo "✅ Jenkins Credentials: 웹에서 확인 필요"
echo "✅ Jenkins URL: http://$SERVER_IP:8080"
```

체크리스트: 터미널:

-   SVN 서비스가 "active" 상태인가요?
-   3690 포트가 LISTEN 상태인가요?
-   /data/svn/microservices/ 디렉토리가 존재하나요?
-   svn list 명령으로 trunk, branches, tags가 보이나요? 웹 (Jenkins):
-   Jenkins Credentials에 3개 항목이 있나요? - svn-credentials (Username with password) - docker-registry-credentials (Username with password) - kubeconfig (Secret file) 모두 확인되셨으면 "5단계 완료"
    또는 "다음"이라고 답변해주세요. 문제가 있으시면 오류 메시지를 알려주세요.
