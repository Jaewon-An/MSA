4단계: Jenkins 설치 및 설정 (OpenJDK 17)

4-1. Java 17 설치

```bash
# 1. Java 17 설치
sudo dnf install -y java-17-openjdk java-17-openjdk-devel
# 2. Java 버전 확인
java -version
# 3. 설치된 Java 목록 확인
sudo alternatives --config java
```

**예상 출력:**

```
openjdk version "17.0.x" 2024-xx-xx LTS
OpenJDK Runtime Environment (Red_Hat-17.0.x.x-x) (build 17.0.x+x-LTS)
OpenJDK 64-Bit Server VM (Red_Hat-17.0.x.x-x) (build 17.0.x+x-LTS, mixed mode, sharing)
There is 1 program that provides 'java'.
  Selection    Command
-----------------------------------------------
*+ 1           java-17-openjdk.x86_64 (/usr/lib/jvm/java-17-openjdk-17.0.x.x-x.el9.x86_64/bin/java)
```

Java 17이 기본으로 선택되지 않았다면:

```bash
# 해당 번호 입력 (보통 1번)
```

JAVA_HOME 설정:

```bash
# 4. JAVA_HOME 설정
echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk' | sudo tee /etc/profile.d/java17.sh
echo 'export PATH=$JAVA_HOME/bin:$PATH' | sudo tee -a /etc/profile.d/java17.sh
source /etc/profile.d/java17.sh
# 5. JAVA_HOME 확인
echo $JAVA_HOME
java -version
```

**예상 출력:**

```
/usr/lib/jvm/java-17-openjdk
openjdk version "17.0.x"
```

4-2. Jenkins 저장소 추가 및 설치

```bash
# 1. Jenkins 저장소 키 추가
sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
# 2. Jenkins GPG 키 가져오기
sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key
# 3. Jenkins 설치
sudo dnf install -y jenkins
# 4. Jenkins 버전 확인
rpm -q jenkins
```

**예상 출력:**

```
jenkins-2.xxx.x-1.1.noarch
```

4-3. Jenkins 홈 디렉토리를 /data로 변경

```bash
# 1. Jenkins 데이터 디렉토리 생성
sudo mkdir -p /data/jenkins
sudo chown -R jenkins:jenkins /data/jenkins
# 2. Jenkins systemd 서비스 파일 수정
sudo sed -i 's|Environment="JENKINS_HOME=/var/lib/jenkins"|Environment="JENKINS_HOME=/data/jenkins"|g' /usr/lib/systemd/system/jenkins.service
# 3. Java 17을 사용하도록 설정 추가
sudo mkdir -p /etc/systemd/system/jenkins.service.d
sudo tee /etc/systemd/system/jenkins.service.d/override.conf > /dev/null <<EOF
[Service]
Environment="JAVA_HOME=/usr/lib/jvm/java-17-openjdk"
Environment="JENKINS_JAVA_CMD=/usr/lib/jvm/java-17-openjdk/bin/java"
EOF
# 4. systemd 재로드
sudo systemctl daemon-reload
# 5. 설정 확인
sudo systemctl cat jenkins.service | grep -E "JENKINS_HOME|JAVA"
```

**예상 출력:**

```
Environment="JENKINS_HOME=/data/jenkins"
Environment="JAVA_HOME=/usr/lib/jvm/java-17-openjdk"
Environment="JENKINS_JAVA_CMD=/usr/lib/jvm/java-17-openjdk/bin/java"
```

4-4. Jenkins 서비스 시작

```bash
# 1. Jenkins 서비스 시작 및 활성화
sudo systemctl start jenkins
sudo systemctl enable jenkins
# 2. Jenkins 상태 확인 (시작에 1-2분 소요)
echo "Jenkins 시작 중... 30초 대기"
sleep 30
sudo systemctl status jenkins
```

**예상 출력:**

```
● jenkins.service - Jenkins Continuous Integration Server
   Loaded: loaded (/usr/lib/systemd/system/jenkins.service; enabled; vendor preset: disabled)
  Drop-In: /etc/systemd/system/jenkins.service.d
           └─override.conf
   Active: active (running) since Tue 2025-01-21 10:00:00 KST; 30s ago
```

만약 시작에 실패하면:

```bash
# 로그 확인
sudo journalctl -u jenkins -n 50 --no-pager
# 일반적인 문제: 포트 충돌
sudo netstat -tulpn | grep 8080
```

4-5. 방화벽 설정

```bash
# 1. Jenkins 포트 오픈
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --reload
# 2. 확인
sudo firewall-cmd --list-ports | grep 8080
```

**예상 출력:**

```
8080/tcp 5000/tcp 6443/tcp ...
```

4-6. Jenkins 초기 관리자 비밀번호 확인

```bash
# 1. Jenkins가 완전히 시작될 때까지 대기
echo "Jenkins 완전 시작 대기 중..."
until sudo test -f /data/jenkins/secrets/initialAdminPassword; do
    echo "대기 중..."
    sleep 5
done
# 2. 초기 비밀번호 확인
echo "=== Jenkins 초기 관리자 비밀번호 ==="
sudo cat /data/jenkins/secrets/initialAdminPassword
echo "================================"
echo "이 비밀번호를 복사해두세요!"
```

**예상 출력:**

```
=== Jenkins 초기 관리자 비밀번호 ===
a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
================================
이 비밀번호를 복사해두세요!
```

4-7. Jenkins 웹 접속 및 초기 설정

```bash
# 서버 IP 확인
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "=============================="
echo "Jenkins URL: http://$SERVER_IP:8080"
echo "=============================="
```

웹 브라우저에서 접속:

```
http://서버IP:8080
```

초기 설정 단계:

1. Unlock Jenkins 화면
    - 위에서 확인한 초기 비밀번호 입력
    - "Continue" 클릭
2. Customize Jenkins 화면
    - "Install suggested plugins" 선택
    - 플러그인 설치 진행 (5-10분 소요)
3. Create First Admin User 화면

```
   Username: admin
   Password: admin123
   Confirm password: admin123
   Full name: Admin
   E-mail address: admin@example.com
```

-   "Save and Continue" 클릭

4. Instance Configuration 화면
    - Jenkins URL 확인: http://서버IP:8080/
    - "Save and Finish" 클릭
5. Jenkins is ready!
    - "Start using Jenkins" 클릭

4-8. 필수 플러그인 설치웹 브라우저에서 계속 진행합니다. Jenkins 대시보드 → Manage Jenkins → Plugins

1. Available plugins 탭 클릭
2. 검색창에서 다음 플러그인을 검색하고 체크박스 선택:

```
   ☑ Docker Pipeline
   ☑ Kubernetes CLI
   ☑ Subversion
   ☑ Pipeline
   ☑ Credentials Binding
   ☑ Git (기본 설치되어 있을 수 있음)
```

3. Install 버튼 클릭
4. 설치 진행 화면에서:
    - "Restart Jenkins when installation is complete and no jobs are running" 체크
    - Jenkins 자동 재시작 대기 (1-2분)
5. 재시작 후 다시 로그인
    - Username: admin
    - Password: admin123

4-9. kubectl을 Jenkins 서버에 설치터미널로 돌아와서:

```bash
# 1. kubectl 다운로드 (이미 설치했지만 확인)
which kubectl || {
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
}
# 2. Jenkins 사용자용 kubeconfig 디렉토리 생성
sudo mkdir -p /data/jenkins/.kube
sudo chown -R jenkins:jenkins /data/jenkins/.kube
# 3. Minikube config를 Jenkins로 복사
mkdir -p ~/.kube
minikube kubectl -- config view --flatten > ~/.kube/config 또는 minikube kubectl -- config view --raw > ~/.kube/config

sudo cp ~/.kube/config /data/jenkins/.kube/config
sudo chown jenkins:jenkins /data/jenkins/.kube/config
sudo chmod 600 /data/jenkins/.kube/config
# 4. Jenkins 사용자로 테스트
sudo -u jenkins kubectl get nodes
```

**예상 출력:**

```
NAME       STATUS   ROLES           AGE   VERSION
minikube   Ready    control-plane   2h    v1.28.0
```

4-10. Jenkins 사용자를 docker 그룹에 추가

```bash
# 1. Jenkins 사용자를 docker 그룹에 추가
sudo usermod -aG docker jenkins
# 2. Jenkins 재시작
sudo systemctl restart jenkins
# 3. 대기 (30초)
echo "Jenkins 재시작 중... 30초 대기"
sleep 30
# 4. Jenkins 사용자로 Docker 테스트
sudo -u jenkins docker ps
```

**예상 출력:**

```
CONTAINER ID   IMAGE        COMMAND       CREATED        STATUS        PORTS                    NAMES
abc123def456   registry:2   "/entrypoint…"   2 hours ago   Up 2 hours   0.0.0.0:5000->5000/tcp   registry
```

4-11. Maven 설치 (Java 프로젝트 빌드용)

```bash
# 1. Maven 설치
sudo dnf install -y maven
# 2. Maven 버전 확인
mvn -version
# 3. Jenkins 사용자로 테스트
sudo -u jenkins mvn -version
```

**예상 출력:**

```
Apache Maven 3.8.x (Red Hat 3.8.x-x)
Maven home: /usr/share/maven
Java version: 17.0.x, vendor: Red Hat, Inc., runtime: /usr/lib/jvm/java-17-openjdk-17.0.x.x-x.el9.x86_64
Default locale: en_US, platform encoding: UTF-8
OS name: "linux", version: "5.14.x", arch: "amd64", family: "unix"
```

✅ 4단계 확인사항터미널에서 확인:

```bash
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "=== 1. Java 17 버전 확인 ==="
java -version 2>&1 | head -1
echo -e "\n=== 2. Jenkins에서 사용하는 Java 확인 ==="
sudo -u jenkins java -version 2>&1 | head -1
echo -e "\n=== 3. Jenkins 서비스 상태 ==="
sudo systemctl is-active jenkins
echo -e "\n=== 4. Jenkins 홈 디렉토리 ==="
ls -la /data/jenkins/ | head -5
echo -e "\n=== 5. kubectl 테스트 (Jenkins 사용자) ==="
sudo -u jenkins kubectl get nodes
echo -e "\n=== 6. Docker 테스트 (Jenkins 사용자) ==="
sudo -u jenkins docker ps | head -2
echo -e "\n=== 7. Maven 버전 (Java 17 사용 확인) ==="
sudo -u jenkins mvn -version | head -3
echo -e "\n=== 8. Jenkins URL ==="
echo "http://$SERVER_IP:8080"
echo -e "\n=== 9. Jenkins 로그인 정보 ==="
echo "Username: admin"
echo "Password: admin123"
```
