# Argo CD 기반 CD 배포 가이드 (Linux에서 설치)

**Linux 서버에서** Argo CD 설치를 수행하고, Git 저장소의 매니페스트(Helm/Kustomize/Plain YAML)를 기반으로 자동 배포·동기화하는 가이드입니다. 설치 명령은 Linux 서버에서 `kubectl`로 실행하며, 설치 후 Argo CD는 01번 문서의 Kubernetes 클러스터에 Pod로 배포됩니다.

> **Argo CD는 Pod로 실행되어야 하나?**  
> 네. Kubernetes 환경에서는 Argo CD가 **클러스터 내부 Pod**(application-controller, server, redis 등)로 실행되는 것이 공식·권장 방식입니다. 클러스터 API 및 Git에 접근해 배포를 수행하므로, 동일(또는 대상) 클러스터 안에서 Pod로 동작하는 구조가 표준입니다.

---

## 목차

1. [기존 Argo CD Pod 완전 삭제 (Kubernetes 사용 중이었던 경우)](#기존-argo-cd-pod-완전-삭제-kubernetes-사용-중이었던-경우)
2. [사전 요구사항](#사전-요구사항)
3. [설치 전 확인](#설치-전-확인)
4. [1단계: Argo CD 설치](#1단계-argo-cd-설치)
5. [2단계: Argo CD 서버 접속](#2단계-argo-cd-서버-접속)
6. [3단계: Git 저장소 연동](#3단계-git-저장소-연동)
7. [4단계: Application 생성 (배포 대상)](#4단계-application-생성-배포-대상)
8. [5단계: 동기화 및 배포 확인](#5단계-동기화-및-배포-확인)
9. [6단계: Jenkins와 연동 (선택)](#6단계-jenkins와-연동-선택)

---

## 기존 Argo CD Pod 완전 삭제 (Kubernetes 사용 중이었던 경우)

이전에 Kubernetes에 Argo CD를 Pod로 배포했다면, Linux에서 재설치하거나 정리하기 전에 아래 순서로 **기존 Argo CD 리소스를 완전히 삭제**합니다.

### 삭제 순서

**Linux 서버**에서 다음을 실행합니다. `kubectl`이 대상 클러스터를 가리키는지 확인하세요.

```bash
# 1. argocd 네임스페이스 내 모든 리소스 확인 (ApplicationSet은 별도 설치 시에만 존재)
kubectl get all,applications,appprojects -n argocd
# ApplicationSet을 별도 설치한 경우: kubectl get applicationsets -n argocd

# 2. Application 등 사용자 리소스 정리 (선택: 네임스페이스 삭제 시 함께 삭제됨)
# 개별 삭제가 필요하면:
# kubectl delete application <이름> -n argocd
# kubectl delete applicationset <이름> -n argocd   # ApplicationSet 설치한 경우만

# 3. argocd 네임스페이스 삭제 (내부 Pod, Service, ConfigMap 등 모두 삭제)
kubectl delete namespace argocd

# 4. 네임스페이스 삭제 대기 (종료 중인 Pod 등 정리될 때까지)
kubectl get namespace argocd   # 삭제 완료될 때까지 반복
```

### CRD 완전 제거 (선택)

Argo CD를 완전히 제거하고 CRD(Application, ApplicationSet 등)까지 지우려면, 네임스페이스 삭제 후 다음을 실행합니다.

```bash
# Argo CD가 등록한 CRD 삭제 (재설치 시 install.yaml이 다시 생성함)
kubectl get crd | grep argoproj.io
# 기본 설치 CRD (applicationsets는 ApplicationSet 별도 설치 시에만 존재)
kubectl delete crd applications.argoproj.io appprojects.argoproj.io
# ApplicationSet을 설치한 경우: kubectl delete crd applicationsets.argoproj.io
# 표시된 다른 argoproj.io CRD가 있으면 동일하게 삭제
```

### Helm으로 설치했던 경우

```bash
helm uninstall argocd -n argocd
kubectl delete pvc -n argocd --all   # PVC가 "Released"로 남을 수 있음
kubectl delete namespace argocd
```

### 삭제 확인

```bash
kubectl get namespace argocd   # Error: namespaces "argocd" not found
kubectl get pods -A | grep argocd   # (결과 없음)
```

이후 본 문서의 **Linux에서 Argo CD 설치** 단계를 진행하면 됩니다.

---

## 사전 요구사항

- **Linux 서버**: RHEL 9 / Rocky Linux 9 / CentOS Stream 9 등 (클러스터 노드이거나 `kubectl`·kubeconfig로 클러스터 접근 가능한 서버)
- **Kubernetes 클러스터**: 01번 문서 기준으로 동작 중 (`kubectl get nodes` 정상)
- **kubectl 및 kubeconfig**: Linux 서버에서 대상 클러스터 접근 가능
- Git 저장소에 배포용 매니페스트 존재 (Helm 차트 또는 Kustomize/일반 YAML)
- (선택) Jenkins 등에서 빌드된 이미지 태그가 매니페스트에 반영된 저장소

---

## 설치 전 확인

**Linux 서버**에서 01번 문서 완료 상태를 전제로, 노드가 `Ready`이고 API Server 접근이 가능한지 확인합니다.

```bash
kubectl cluster-info
kubectl get nodes
```

### 네트워크 (매니페스트 다운로드)

Argo CD 설치 시 GitHub 등에서 YAML을 받으므로, **이 Linux 서버**에서 해당 URL 접근이 가능해야 합니다.

```bash
curl -sI https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml | head -1
```

**예상:** `HTTP/2 200` 또는 `HTTP/1.1 200 OK`

---

## 1단계: Argo CD 설치

아래 명령은 모두 **Linux 서버**에서 실행합니다.

### 1-1. Argo CD 네임스페이스 및 설치

```bash
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

### 1-2. 배포 완료 대기

```bash
kubectl get pods -n argocd -w
# Ctrl+C 후
kubectl get pods -n argocd
```

**예상:** `application-controller`, `argocd-server`, `redis` 등 모든 Pod가 `Running` 상태.

### 1-3. 설치 검증

```bash
kubectl get pods -n argocd
kubectl get svc -n argocd
```

**예상:** `argocd-application-controller`, `argocd-server`, `argocd-redis` 등 Pod가 모두 `Running`입니다.

### 1-4. Argo CD CLI 설치 (선택, Linux 서버 기준)

#### Linux 아키텍처 확인 (linux-amd64 / x86_64)

```bash
uname -m
# x86_64 → amd64 바이너리 사용 (argocd-linux-amd64)
# aarch64, arm64 → argocd-linux-arm64 사용
```

#### Linux (x86_64/amd64) CLI 설치

`uname -m`이 `x86_64`인 경우:

```bash
curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
chmod +x argocd
sudo mv argocd /usr/local/bin/
argocd version --client
```

#### Linux (arm64)

```bash
curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-arm64
chmod +x argocd
sudo mv argocd /usr/local/bin/
argocd version --client
```

CLI 설치 후 버전 확인: `argocd version --client`

---

## 2단계: Argo CD 서버 접속

### 2-1. NodePort로 서비스 노출

기본 설치에는 LoadBalancer/Ingress가 없을 수 있으므로 NodePort로 접근합니다. **Linux 서버**에서:

```bash
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "NodePort"}}'
kubectl get svc -n argocd argocd-server
```

**예상:** `argocd-server`의 PORT(S)에 `8080:3xxxx/TCP` 형태로 NodePort 확인.

### 2-2. 초기 비밀번호 확인

```bash
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
echo
```

사용자명: `admin`

### 2-3. 웹 UI 접속

- 브라우저: `https://<노드IP>:<NodePort>` (예: https://172.16.0.194:30443)
- 첫 접속 시 인증서 경고는 "고급" → "접속"으로 진행
- 로그인: admin / (위에서 확인한 비밀번호)

---

## 3단계: Git 저장소 연동

### 3-1. Repository 등록 (UI)

- Settings → Repositories → Connect Repo
- Repository URL: GitLab 등 저장소 URL (예: https://gitlab.com/your-group/your-repo.git)
- Authentication: HTTPS Username/Password 또는 SSH Key

### 3-2. Repository 등록 (CLI, Linux 서버에서)

```bash
argocd repo add https://gitlab.com/your-group/your-repo.git \
  --username <user> \
  --password <token-or-password>
```

### 3-3. 연결 테스트

- Repositories 목록에서 해당 저장소의 Connection Status가 **Successful**인지 확인

---

## 4단계: Application 생성 (배포 대상)

### 4-1. Application 정의 (YAML 예시)

Git 저장소에 애플리케이션 매니페스트가 있는 경우, Argo CD Application으로 해당 경로를 가리킵니다.

```yaml
# application.yaml (로컬에서 적용하거나 Argo CD가 관리하는 배포용 레포에 둠)
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: myapp
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://gitlab.com/your-group/your-repo.git
    path: k8s/overlays/dev          # Kustomize overlays 예시
    targetRevision: HEAD
  destination:
    server: https://kubernetes.default.svc
    namespace: myapp
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

**Helm 사용 시** `source` 예시:

```yaml
  source:
    repoURL: https://gitlab.com/your-group/your-repo.git
    path: charts/myapp
    helm:
      valueFiles:
        - values-dev.yaml
```

### 4-2. Application 적용 (Linux 서버에서)

```bash
kubectl apply -f application.yaml
```

### 4-3. UI에서 Application 확인

- Argo CD 웹 UI → Applications
- 해당 앱 선택 후 Sync Status, Health 확인
- **Sync** 버튼으로 수동 동기화 가능

---

## 5단계: 동기화 및 배포 확인

### 5-1. 동기화 상태 (Linux 서버에서)

```bash
argocd app list
argocd app get myapp
```

### 5-2. 수동 Sync (필요 시)

```bash
argocd app sync myapp
```

### 5-3. 배포된 리소스 확인

```bash
kubectl get all -n myapp
```

---

## 6단계: Jenkins와 연동 (선택)

- Jenkins 파이프라인에서 이미지 빌드·푸시 후, 배포용 Git 저장소의 이미지 태그만 변경하고 커밋·푸시하면 Argo CD가 자동으로 감지하여 배포할 수 있습니다.
- 또는 Argo CD Image Updater 사용 시 이미지 태그 자동 갱신 가능.

---

## 요약 및 참고

| 항목 | 내용 |
|------|------|
| 설치 수행 | Linux 서버에서 `kubectl`로 설치 |
| Argo CD 동작 위치 | Kubernetes 클러스터 내 Pod |
| 네임스페이스 | argocd |
| 접속 | https://172.16.0.194:\<NodePort\>, 사용자 admin |
| 배포 원천 | Git 저장소 (Helm/Kustomize/Plain YAML) |
| 동기화 | 자동(selfHeal, prune) 또는 수동 Sync |

- **기존 Argo CD 제거:** 문서 상단 [기존 Argo CD Pod 완전 삭제](#기존-argo-cd-pod-완전-삭제-kubernetes-사용-중이었던-경우) 참고
- **공식 문서:** https://argo-cd.readthedocs.io/
- **문제 발생 시:** `kubectl logs -n argocd -l app.kubernetes.io/name=argocd-application-controller -f`
