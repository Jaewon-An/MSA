apiVersion: apps/v1
kind: Deployment
metadata:
  name: h-cms
  namespace: dev
  labels:
    app: h-cms
spec:
  replicas: 1
  selector:
    matchLabels:
      app: h-cms
  template:
    metadata:
      labels:
        app: h-cms
    spec:
      imagePullSecrets:
        - name: registry-secret
      containers:
        - name: h-cms
          image: '172.16.0.194:5000/h-cms:latest'
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          volumeMounts:
            # Tomcat 설정 디렉터리를 컨테이너 바깥(호스트) 볼륨으로 마운트
            - name: tomcat-conf
              mountPath: /usr/local/tomcat/conf
              readOnly: false
          resources:
            requests:
              memory: '256Mi'
              cpu: '100m'
            limits:
              memory: '512Mi'
              cpu: '500m'
          # TCP 프로브: 8080 포트만 확인 (루트(/)가 404여도 통과)
          livenessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 90
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 5
      volumes:
        # 호스트의 설정 디렉터리. 경로는 노드 환경에 맞게 변경 (예: /opt/tomcat-deploy/h-cms/conf)
        - name: tomcat-conf
          hostPath:
            path: /root/tomcat-war-deploy/h-cms/conf
            type: DirectoryOrCreate
---
apiVersion: v1
kind: Service
metadata:
  name: h-cms
  namespace: dev
spec:
  selector:
    app: h-cms
  ports:
    - port: 80
      targetPort: 8080
  type: ClusterIP
