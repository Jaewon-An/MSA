# Argo CD 기반 CD 배포 가이드

Kubernetes 클러스터에 Argo CD를 설치하고, Git 저장소의 매니페스트(Helm/Kustomize/Plain YAML)를 기반으로 자동 배포·동기화하는 가이드입니다. 01번 문서의 Kubernetes 단일 노드 환경을 기준으로 합니다.

---

## 사전 요구사항

- Kubernetes 클러스터 동작 중 (`kubectl get nodes` 정상)
- Git 저장소에 배포용 매니페스트 존재 (Helm 차트 또는 Kustomize/일반 YAML)
- (선택) Jenkins 등에서 빌드된 이미지 태그가 매니페스트에 반영된 저장소

---

## 설치 전 확인

### 클러스터 및 kubectl
```bash
kubectl cluster-info
kubectl get nodes
```
노드가 `Ready`이고 API Server에 접근 가능해야 합니다.

### 네트워크 (매니페스트 다운로드)
Argo CD 설치 시 GitHub 등에서 YAML을 받으므로, 클러스터 노드(또는 실행 환경)에서 해당 URL 접근이 가능해야 합니다.

```bash
curl -sI https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml | head -1
```
**예상:** `HTTP/2 200` 또는 `HTTP/1.1 200 OK`

---

## 1단계: Argo CD 설치

### 1-1. Argo CD 네임스페이스 및 설치
```bash
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

### 1-2. 배포 완료 대기
```bash
kubectl get pods -n argocd -w
# Ctrl+C 후
kubectl get pods -n argocd
```

**예상:** `application-controller`, `argocd-server`, `redis` 등 모든 Pod가 `Running` 상태.

### 1-3. 설치 검증
```bash
kubectl get pods -n argocd
kubectl get svc -n argocd
```
**예상:** `argocd-application-controller`, `argocd-server`, `argocd-redis` 등 Pod가 모두 `Running`입니다.

### 1-4. Argo CD CLI 설치 (선택)

#### Linux 아키텍처 확인 (linux-amd64 / x86_64)
```bash
# 방법 1: uname (가장 일반적)
uname -m
# x86_64 → amd64 바이너리 사용 (argocd-linux-amd64)
# aarch64, arm64 → argocd-linux-arm64 사용
# i686, i386 → 32비트; Argo CD는 공식 64비트만 제공

# 방법 2: arch 명령
arch
# x86_64 이면 amd64

# 방법 3: Debian/Ubuntu 계열
dpkg --print-architecture
# amd64 이면 argocd-linux-amd64 사용
```

**정리:** `uname -m` 결과가 **x86_64**이면 **linux-amd64** 아키텍처이므로 아래 "Linux (x86_64/amd64)" 절차를 따릅니다.

#### Linux (x86_64/amd64) CLI 설치
`uname -m`이 `x86_64`인 경우:
```bash
curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
chmod +x argocd
sudo mv argocd /usr/local/bin/
argocd version --client
```

#### 기타 환경
```bash
# Linux (arm64, uname -m 이 aarch64인 경우)
# curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-arm64

# Windows (PowerShell, 관리자 권한 시)
# https://github.com/argoproj/argo-cd/releases 에서 argocd-windows-amd64.exe 다운로드 후 PATH에 추가

# macOS (Intel, x86_64)
curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-darwin-amd64
chmod +x argocd
sudo mv argocd /usr/local/bin/

# macOS (Apple Silicon, arm64)
curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-darwin-arm64
chmod +x argocd
sudo mv argocd /usr/local/bin/
```
CLI 설치 후 버전 확인: `argocd version --client`

---

## 2단계: Argo CD 서버 접속

### 2-1. NodePort로 서비스 노출
기본 설치에는 LoadBalancer/Ingress가 없을 수 있으므로 NodePort로 접근합니다.

```bash
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "NodePort"}}'
kubectl get svc -n argocd argocd-server
```

**예상:** `argocd-server`의 PORT(S)에 `8080:3xxxx/TCP` 형태로 NodePort 확인.

### 2-2. 초기 비밀번호 확인
```bash
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
echo
```

사용자명: `admin`

### 2-3. 웹 UI 접속
- 브라우저: `https://<노드IP>:<NodePort>` (예: https://172.16.0.10:30443)
- 첫 접속 시 인증서 경고는 "고급" → "접속"으로 진행
- 로그인: admin / (위에서 확인한 비밀번호)

---

## 3단계: Git 저장소 연동

### 3-1. Repository 등록 (UI)
- Settings → Repositories → Connect Repo
- Repository URL: GitLab 등 저장소 URL (예: https://gitlab.com/your-group/your-repo.git)
- Authentication: HTTPS Username/Password 또는 SSH Key

### 3-2. Repository 등록 (CLI)
```bash
argocd repo add https://gitlab.com/your-group/your-repo.git \
  --username <user> \
  --password <token-or-password>
```

### 3-3. 연결 테스트
- Repositories 목록에서 해당 저장소의 Connection Status가 **Successful**인지 확인

---

## 4단계: Application 생성 (배포 대상)

### 4-1. Application 정의 (YAML 예시)
Git 저장소에 애플리케이션 매니페스트가 있는 경우, Argo CD Application으로 해당 경로를 가리킵니다.

```yaml
# application.yaml (로컬에서 적용하거나 Argo CD가 관리하는 배포용 레포에 둠)
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: myapp
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://gitlab.com/your-group/your-repo.git
    path: k8s/overlays/dev          # Kustomize overlays 예시
    targetRevision: HEAD
  destination:
    server: https://kubernetes.default.svc
    namespace: myapp
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

- **Helm 사용 시** `source` 예시:
```yaml
  source:
    repoURL: https://gitlab.com/your-group/your-repo.git
    path: charts/myapp
    helm:
      valueFiles:
        - values-dev.yaml
```

### 4-2. Application 적용
```bash
kubectl apply -f application.yaml
```

### 4-3. UI에서 Application 확인
- Argo CD 웹 UI → Applications
- 해당 앱 선택 후 Sync Status, Health 확인
- **Sync** 버튼으로 수동 동기화 가능

---

## 5단계: 동기화 및 배포 확인

### 5-1. 동기화 상태
```bash
argocd app list
argocd app get myapp
```

### 5-2. 수동 Sync (필요 시)
```bash
argocd app sync myapp
```

### 5-3. 배포된 리소스 확인
```bash
kubectl get all -n myapp
```

---

## 6단계: Jenkins와 연동 (선택)

- Jenkins 파이프라인에서 이미지 빌드·푸시 후, 배포용 Git 저장소의 이미지 태그만 변경하고 커밋·푸시하면 Argo CD가 자동으로 감지하여 배포할 수 있습니다.
- 또는 Argo CD Image Updater 사용 시 이미지 태그 자동 갱신 가능.

---

## 요약 및 참고

| 항목 | 내용 |
|------|------|
| 네임스페이스 | argocd |
| 접속 | https://\<노드IP\>:\<NodePort\>, 사용자 admin |
| 배포 원천 | Git 저장소 (Helm/Kustomize/Plain YAML) |
| 동기화 | 자동(selfHeal, prune) 또는 수동 Sync |

- **공식 문서:** https://argo-cd.readthedocs.io/
- **문제 발생 시:** `kubectl logs -n argocd -l app.kubernetes.io/name=argocd-application-controller -f`
