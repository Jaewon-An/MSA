# GitLab 소스관리 가이드

소스 코드·배포 매니페스트·설정을 GitLab으로 관리하고, Jenkins·Argo CD와 연동하기 위한 저장소 구성 및 기본 워크플로우 가이드입니다.

---

## 사전 요구사항

- GitLab 서버 접근 가능 (self-hosted 또는 GitLab.com)
- Git 클라이언트 설치 (로컬 PC 또는 개발 서버)
- (선택) SSH 키 또는 Personal Access Token

---

## GitLab 서버 설치 (Self-Hosted)

GitLab.com을 사용할 경우 이 단계는 생략합니다. 자체 서버에 GitLab을 설치할 때 참고합니다.

### Kubernetes에 GitLab 설치 (Helm)

클러스터에 GitLab을 배포하는 방법입니다. 리소스가 충분한 환경에서 사용하세요.

```bash
# Helm repo 추가
helm repo add gitlab https://charts.gitlab.io
helm repo update

# 네임스페이스 생성
kubectl create namespace gitlab

# 설치 (최소 설정 예시, 실제로는 values.yaml로 URL·인증 등 설정)
# 공식 차트: https://docs.gitlab.com/charts/
helm install gitlab gitlab/gitlab -n gitlab \
  --set global.hosts.domain=your-domain.com \
  --set global.edition=ce
```

설치 후 root 비밀번호는 다음으로 확인합니다.
```bash
kubectl get secret -n gitlab gitlab-gitlab-initial-root-password -o jsonpath='{.data.password}' | base64 -d
echo
```

### Docker로 GitLab 설치 (단일 서버)

Kubernetes 외부, Rocky Linux 등 단일 서버에서 Docker로 실행하는 예시입니다.

```bash
# Docker 설치 (이미 있으면 생략)
sudo dnf install -y docker
sudo systemctl enable docker
sudo systemctl start docker

# GitLab 컨테이너 실행 (호스트 8080→80, 8443→443, 2222→22)
sudo docker run --detach \
  --hostname gitlab.example.com \
  --publish 8443:443 --publish 8080:80 --publish 2222:22 \
  --name gitlab \
  --restart unless-stopped \
  --volume gitlab-config:/etc/gitlab \
  --volume gitlab-logs:/var/log/gitlab \
  --volume gitlab-data:/var/opt/gitlab \
  gitlab/gitlab-ce:latest
```

초기 root 비밀번호는 로그에서 확인합니다.
```bash
sudo docker exec -it gitlab grep 'Password:' /etc/gitlab/initial_root_password
```

### Git 클라이언트 설치 (로컬 PC)

```bash
# Rocky / RHEL / CentOS
sudo dnf install -y git

# Windows: https://git-scm.com/download/win 에서 설치
# macOS: brew install git
```

```bash
git --version
```

---

## 1단계: GitLab 저장소 구조 제안

Jenkins 빌드와 Argo CD 배포를 함께 사용할 때 권장하는 저장소 구성을 예시로 둡니다.

### 1-1. 애플리케이션 단일 저장소 예시
```
your-app/
├── src/                    # 애플리케이션 소스
├── Jenkinsfile             # Jenkins Pipeline 정의
├── Dockerfile
├── k8s/                    # Argo CD가 참조할 배포 매니페스트
│   ├── base/               # Kustomize base 또는 공통 YAML
│   └── overlays/
│       ├── dev/
│       └── prod
└── README.md
```

### 1-2. 배포 전용 저장소 (GitOps) 예시
소스와 배포를 분리할 경우, 배포 전용 저장소를 두고 Argo CD만 이 저장소를 가리키게 할 수 있습니다.

```
deploy-repo/
├── apps/
│   └── myapp/
│       ├── base/
│       └── overlays/
│           ├── dev
│           └── prod
└── README.md
```

---

## 2단계: GitLab에서 저장소 생성

### 2-1. 새 프로젝트 생성
- GitLab → New project → Create blank project
- Project name, Visibility 설정 후 Create project

### 2-2. SSH 키 등록 (SSH 사용 시)
```bash
# 로컬에서 공개키 확인
cat ~/.ssh/id_rsa.pub
```
- GitLab → User Settings → SSH Keys → Add key

### 2-3. Personal Access Token (HTTPS/API 사용 시)
- User Settings → Access Tokens
- Scope: `read_repository`, `write_repository` (필요에 따라 추가)
- 토큰 생성 후 복사해 두기 (한 번만 표시됨)

---

## 3단계: 로컬에서 Git 기본 설정

### 3-1. 사용자 정보 (최초 1회)
```bash
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
```

### 3-2. 저장소 Clone
```bash
# HTTPS
git clone https://gitlab.com/your-group/your-repo.git
cd your-repo

# SSH
git clone git@gitlab.com:your-group/your-repo.git
cd your-repo
```

### 3-3. 브랜치 전략 예시
- `main` / `master`: 운영 반영용
- `develop`: 개발 통합
- `feature/*`, `release/*`: 기능/릴리스 브랜치

---

## 4단계: Jenkins와 연동

### 4-1. Jenkins Credentials 등록
- Manage Jenkins → Credentials → Add
- Kind: Username with password 또는 SSH Username with private key
- GitLab 사용자/비밀번호 또는 Personal Access Token, 또는 SSH Private Key 입력
- ID: 예) `gitlab-credentials`

### 4-2. Pipeline Job에서 Git 설정
- Job → Configure → Pipeline section
- Definition: Pipeline script from SCM
- SCM: Git
- Repository URL: GitLab 저장소 URL
- Credentials: 위에서 만든 Credential 선택
- Branch: `*/main` 또는 `*/develop` 등

### 4-3. 웹훅 (선택)
- GitLab 프로젝트 → Settings → Webhooks
- URL: `http://<Jenkins_URL>/project/<Job명>/generic-webhook-trigger` 등 (Jenkins 플러그인에 따라 상이)
- Push events 체크 후 Add webhook
- 커밋 시 자동 빌드 가능

---

## 5단계: Argo CD와 연동

### 5-1. Argo CD에 GitLab 저장소 등록
- Argo CD → Settings → Repositories → Connect Repo
- Repository URL: GitLab 저장소 URL (예: https://gitlab.com/your-group/your-repo.git)
- Authentication: Username/Password에 GitLab 사용자 + Personal Access Token 또는 비밀번호

### 5-2. Application의 targetRevision
- `HEAD`, `main`, `master`, `develop` 또는 특정 태그/커밋 SHA 지정
- 배포용 매니페스트가 있는 경로(`path`)를 정확히 지정

### 5-3. 변경 반영 흐름
1. 개발자가 소스 수정 후 GitLab에 푸시
2. Jenkins가 빌드·이미지 푸시 후, 배포 저장소의 이미지 태그 등 수정 후 푸시 (또는 수동 커밋)
3. Argo CD가 Git 변경 감지 후 자동 Sync (automated syncPolicy 사용 시)

---

## 6단계: 기본 워크플로우 요약

| 단계 | 도구 | 설명 |
|------|------|------|
| 1. 소스 보관 | GitLab | 코드, Jenkinsfile, k8s 매니페스트 저장 |
| 2. 빌드 | Jenkins | GitLab에서 Clone → 빌드 → 이미지 Push (04. Jenkins 가이드) |
| 3. 배포 | Argo CD | GitLab의 k8s 경로를 보고 클러스터에 배포 (05. Argo CD 가이드) |

---

## 요약 및 참고

| 항목 | 내용 |
|------|------|
| 저장소 | GitLab (self-hosted 또는 GitLab.com) |
| 인증 | SSH Key 또는 Personal Access Token |
| Jenkins | Credentials로 Git 연동, Pipeline from SCM |
| Argo CD | Repositories에 GitLab URL + 인증 등록 |

- **Private 저장소:** Jenkins·Argo CD 모두 해당 저장소에 대한 읽기 권한이 있는 계정/토큰 사용
- **문제 발생 시:** GitLab Audit Events, Jenkins 빌드 로그, Argo CD Application Sync 결과로 단계별 확인
